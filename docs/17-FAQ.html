<html><head><title>doobie</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Rob Norris" /><meta name="description" content="A principled JDBC layer for Scala." /><meta name="og:image" content="/doobie/img/poster.png" /><meta name="og:title" content="doobie" /><meta name="og:site_name" content="doobie" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="A principled JDBC layer for Scala." /><link rel="icon" type="image/png" href="/doobie/img/favicon.png" /><meta name="twitter:title" content="doobie" /><meta name="twitter:image" content="img/poster.png" /><meta name="twitter:description" content="A principled JDBC layer for Scala." /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/doobie/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/doobie/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/doobie/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/doobie/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/doobie/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/doobie/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/doobie/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/doobie/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/doobie/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/doobie/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/doobie/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/doobie/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/doobie/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/doobie/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/doobie/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/doobie/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/doobie/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/doobie/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/doobie/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/doobie/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/doobie/highlight/styles/color-brewer.css" /><link rel="stylesheet" href="/doobie/css/style.css" /><link rel="stylesheet" href="/doobie/css/palette.css" /><link rel="stylesheet" href="/doobie/css/codemirror.css" /><link rel="stylesheet" href="/doobie/css/tweak.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/doobie/" class="brand"><div class="brand-wrapper"><span>doobie</span></div></a></li><li><a href="/doobie/docs/01-Introduction.html" class="">Introduction</a></li><li><a href="/doobie/docs/02-Toolkit.html" class="">Toolkit</a></li><li><a href="/doobie/docs/03-Connecting.html" class="">Connecting to a Database</a></li><li><a href="/doobie/docs/04-Selecting.html" class="">Selecting Data</a></li><li><a href="/doobie/docs/05-Parameterized.html" class="">Parameterized Queries</a></li><li><a href="/doobie/docs/06-Checking.html" class="">Typechecking Queries</a></li><li><a href="/doobie/docs/07-Updating.html" class="">DDL, Inserting, and Updating</a></li><li><a href="/doobie/docs/08-Fragments.html" class="">Statement Fragments</a></li><li><a href="/doobie/docs/09-Error-Handling.html" class="">Error Handling</a></li><li><a href="/doobie/docs/10-Logging.html" class="">Logging</a></li><li><a href="/doobie/docs/11-Arrays.html" class="">SQL Arrays</a></li><li><a href="/doobie/docs/12-Custom-Mappings.html" class="">Custom Mappings</a></li><li><a href="/doobie/docs/13-Unit-Testing.html" class="">Unit Testing</a></li><li><a href="/doobie/docs/14-Managing-Connections.html" class="">Managing Connections</a></li><li><a href="/doobie/docs/15-Extensions-PostgreSQL.html" class="">Extensions for PostgreSQL</a></li><li><a href="/doobie/docs/16-Extensions-H2.html" class="">Extensions for H2</a></li><li><a href="/doobie/docs/17-FAQ.html" class=" active ">Frequently-Asked Questions</a></li><li><a href="/doobie/" class=""></a></li><li><a href="/doobie/css/palette.css" class=""></a></li><li><a href="/doobie/css/style.css" class=""></a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/tpolecat/doobie"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/tpolecat/doobie"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('doobie A principled JDBC layer for Scala.');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('doobie A principled JDBC layer for Scala.');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="tpolecat" data-github-repo="doobie"><div class="content-wrapper"><section><h2 id="frequently-asked-questions">Frequently-Asked Questions</h2>

<p>In this chapter we address some frequently-asked questions, in no particular order. First a bit of set-up.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats._</span>
<span class="k">import</span> <span class="nn">cats.data._</span>
<span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">doobie._</span>
<span class="k">import</span> <span class="nn">doobie.implicits._</span>
<span class="k">import</span> <span class="nn">java.awt.geom.Point2D</span>
<span class="k">import</span> <span class="nn">java.util.UUID</span>
<span class="k">import</span> <span class="nn">shapeless._</span>

<span class="k">val</span> <span class="n">xa</span> <span class="k">=</span> <span class="nc">Transactor</span><span class="o">.</span><span class="n">fromDriverManager</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span>
  <span class="s">"org.postgresql.Driver"</span><span class="o">,</span> <span class="s">"jdbc:postgresql:world"</span><span class="o">,</span> <span class="s">"postgres"</span><span class="o">,</span> <span class="s">""</span>
<span class="o">)</span>

<span class="k">val</span> <span class="n">y</span> <span class="k">=</span> <span class="n">xa</span><span class="o">.</span><span class="n">yolo</span>
<span class="k">import</span> <span class="nn">y._</span>
</code></pre>
</div>

<h3 id="how-do-i-do-an-in-clause">How do I do an <code class="highlighter-rouge">IN</code> clause?</h3>

<p>This used to be very irritating, but as of 0.4.0 there is a good solution. See the section on <code class="highlighter-rouge">IN</code> clauses in <a href="05-Parameterized.html">Chapter 5</a> and <a href="08-Fragments.html">Chapter 8</a> on statement fragments.</p>

<h3 id="how-do-i-ascribe-an-sql-type-to-an-interpolated-parameter">How do I ascribe an SQL type to an interpolated parameter?</h3>

<p>Interpolated parameters are replaced with <code class="highlighter-rouge">?</code> placeholders, so if you need to ascribe an SQL type you can use vendor-specific syntax in conjunction with the interpolated value. For example, in PostgreSQL you use <code class="highlighter-rouge">:: type</code>:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">s</span> <span class="k">=</span> <span class="s">"foo"</span>
<span class="n">s</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">foo</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">sql</span><span class="s">"select $s"</span><span class="o">.</span><span class="n">query</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">check</span><span class="o">.</span><span class="n">unsafeRunSync</span>

  <span class="n">select</span> <span class="o">?</span>

  <span class="o">✕</span> <span class="nc">SQL</span> <span class="nc">Compiles</span> <span class="n">and</span> <span class="nc">Typechecks</span>
    <span class="o">-</span> <span class="nc">ERROR</span><span class="k">:</span> <span class="kt">could</span> <span class="kt">not</span> <span class="kt">determine</span> <span class="kt">data</span> <span class="k">type</span> <span class="kt">of</span> <span class="kt">parameter</span> <span class="kt">$1</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">sql</span><span class="s">"select $s :: char"</span><span class="o">.</span><span class="n">query</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">check</span><span class="o">.</span><span class="n">unsafeRunSync</span>

  <span class="n">select</span> <span class="o">?</span> <span class="o">::</span> <span class="n">char</span>

  <span class="o">✓</span> <span class="nc">SQL</span> <span class="nc">Compiles</span> <span class="n">and</span> <span class="nc">Typechecks</span>
  <span class="o">✓</span> <span class="n">P01</span> <span class="nc">String</span>  <span class="o">→</span>  <span class="nc">CHAR</span> <span class="o">(</span><span class="n">bpchar</span><span class="o">)</span>
  <span class="o">✓</span> <span class="n">C01</span> <span class="n">bpchar</span> <span class="nc">CHAR</span> <span class="o">(</span><span class="n">bpchar</span><span class="o">)</span> <span class="nc">NULL</span><span class="o">?</span>  <span class="o">→</span>  <span class="nc">String</span>
</code></pre>
</div>

<h3 id="how-do-i-do-several-things-in-the-same-transaction">How do I do several things in the same transaction?</h3>

<p>You can use a <code class="highlighter-rouge">for</code> comprehension to compose any number of <code class="highlighter-rouge">ConnectionIO</code> programs, and then call <code class="highlighter-rouge">.transact(xa)</code> on the result. All of the composed programs will run in the same transaction. For this reason it’s useful for your APIs to expose values in <code class="highlighter-rouge">ConnectionIO</code>, so higher-level code can place transaction boundaries as needed.</p>

<h3 id="how-do-i-run-something-outside-of-a-transaction">How do I run something outside of a transaction?</h3>

<p><code class="highlighter-rouge">Transactor.transact</code> takes a <code class="highlighter-rouge">ConnectionIO</code> and constructs an <code class="highlighter-rouge">IO</code> or similar that will run it in a single transaction, but it is also possible to include transaction boundaries <em>within</em> a <code class="highlighter-rouge">ConnectionIO</code>, and to disable transaction handling altogether. Some kinds of DDL statements may require this for some databases. You can define a combinator to do this for you.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Take a program `p` and return an equivalent one that first commits
 * any ongoing transaction, runs `p` without transaction handling, then
 * starts a new transaction.
 */</span>
<span class="k">def</span> <span class="n">withoutTransaction</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">p</span><span class="k">:</span> <span class="kt">ConnectionIO</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">ConnectionIO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">FC</span><span class="o">.</span><span class="n">setAutoCommit</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">*&gt;</span> <span class="n">p</span> <span class="o">&lt;*</span> <span class="nc">FC</span><span class="o">.</span><span class="n">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
</code></pre>
</div>

<p>Note that you need both of these operations if you are using a <code class="highlighter-rouge">Transactor</code> because it will always start a transaction and will try to commit on completion.</p>

<h3 id="how-do-i-turn-an-arbitrary-sql-string-into-a-query0update0">How do I turn an arbitrary SQL string into a <code class="highlighter-rouge">Query0/Update0</code>?</h3>

<p>As of <strong>doobie</strong> 0.4.0 this is done via <a href="08-Fragments.html">statement fragments</a>. Here we choose the sort order dynamically.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Code</span><span class="o">(</span><span class="n">country</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">City</span><span class="o">(</span><span class="n">code</span><span class="k">:</span> <span class="kt">Code</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">population</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

<span class="k">def</span> <span class="n">cities</span><span class="o">(</span><span class="n">code</span><span class="k">:</span> <span class="kt">Code</span><span class="o">,</span> <span class="n">asc</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Query0</span><span class="o">[</span><span class="kt">City</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">ord</span> <span class="k">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">asc</span><span class="o">)</span> <span class="n">fr</span><span class="s">"ASC"</span> <span class="k">else</span> <span class="n">fr</span><span class="s">"DESC"</span>
  <span class="k">val</span> <span class="n">sql</span> <span class="k">=</span> <span class="n">fr</span><span class="s">"""
    SELECT countrycode, name, population
    FROM   city
    WHERE  countrycode = $code
    ORDER BY name"""</span> <span class="o">++</span> <span class="n">ord</span>
  <span class="n">sql</span><span class="o">.</span><span class="n">query</span><span class="o">[</span><span class="kt">City</span><span class="o">]</span>
<span class="o">}</span>
</code></pre>
</div>

<p>We can check the resulting <code class="highlighter-rouge">Query0</code> as expected.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>scala&gt; cities(Code("USA"), true).check.unsafeRunSync

      SELECT countrycode, name, population
      FROM   city
      WHERE  countrycode = ?
      ORDER BY name ASC 

  ✓ SQL Compiles and Typechecks
  ✓ P01 Code  →  CHAR (bpchar)
  ✓ C01 countrycode CHAR    (bpchar)  NOT NULL  →  Code
  ✓ C02 name        VARCHAR (varchar) NOT NULL  →  String
  ✓ C03 population  INTEGER (int4)    NOT NULL  →  Int
</code></pre>
</div>

<p>And it works!</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="n">cities</span><span class="o">(</span><span class="nc">Code</span><span class="o">(</span><span class="s">"USA"</span><span class="o">),</span> <span class="kc">true</span><span class="o">).</span><span class="n">process</span><span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span>
  <span class="nc">City</span><span class="o">(</span><span class="nc">Code</span><span class="o">(</span><span class="nc">USA</span><span class="o">),</span><span class="nc">Abilene</span><span class="o">,</span><span class="mi">115930</span><span class="o">)</span>
  <span class="nc">City</span><span class="o">(</span><span class="nc">Code</span><span class="o">(</span><span class="nc">USA</span><span class="o">),</span><span class="nc">Akron</span><span class="o">,</span><span class="mi">217074</span><span class="o">)</span>
  <span class="nc">City</span><span class="o">(</span><span class="nc">Code</span><span class="o">(</span><span class="nc">USA</span><span class="o">),</span><span class="nc">Albany</span><span class="o">,</span><span class="mi">93994</span><span class="o">)</span>
  <span class="nc">City</span><span class="o">(</span><span class="nc">Code</span><span class="o">(</span><span class="nc">USA</span><span class="o">),</span><span class="nc">Albuquerque</span><span class="o">,</span><span class="mi">448607</span><span class="o">)</span>
  <span class="nc">City</span><span class="o">(</span><span class="nc">Code</span><span class="o">(</span><span class="nc">USA</span><span class="o">),</span><span class="nc">Alexandria</span><span class="o">,</span><span class="mi">128283</span><span class="o">)</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">cities</span><span class="o">(</span><span class="nc">Code</span><span class="o">(</span><span class="s">"USA"</span><span class="o">),</span> <span class="kc">false</span><span class="o">).</span><span class="n">process</span><span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span>
  <span class="nc">City</span><span class="o">(</span><span class="nc">Code</span><span class="o">(</span><span class="nc">USA</span><span class="o">),</span><span class="nc">Yonkers</span><span class="o">,</span><span class="mi">196086</span><span class="o">)</span>
  <span class="nc">City</span><span class="o">(</span><span class="nc">Code</span><span class="o">(</span><span class="nc">USA</span><span class="o">),</span><span class="nc">Worcester</span><span class="o">,</span><span class="mi">172648</span><span class="o">)</span>
  <span class="nc">City</span><span class="o">(</span><span class="nc">Code</span><span class="o">(</span><span class="nc">USA</span><span class="o">),</span><span class="nc">Winston</span><span class="o">-</span><span class="nc">Salem</span><span class="o">,</span><span class="mi">185776</span><span class="o">)</span>
  <span class="nc">City</span><span class="o">(</span><span class="nc">Code</span><span class="o">(</span><span class="nc">USA</span><span class="o">),</span><span class="nc">Wichita</span> <span class="nc">Falls</span><span class="o">,</span><span class="mi">104197</span><span class="o">)</span>
  <span class="nc">City</span><span class="o">(</span><span class="nc">Code</span><span class="o">(</span><span class="nc">USA</span><span class="o">),</span><span class="nc">Wichita</span><span class="o">,</span><span class="mi">344284</span><span class="o">)</span>
</code></pre>
</div>

<h3 id="how-do-i-handle-outer-joins">How do I handle outer joins?</h3>

<p>With an outer join you end up with set of nullable columns, which you typically want to map to a single <code class="highlighter-rouge">Option</code> of some composite type, which doobie can do for you. If all columns are null you will get back <code class="highlighter-rouge">None</code>.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Country</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">code</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">City</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">district</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">val</span> <span class="n">join</span> <span class="k">=</span>
  <span class="n">sql</span><span class="s">"""
    select c.name, c.code,
           k.name, k.district
    from country c
    left outer join city k
    on c.capital = k.id
  """</span><span class="o">.</span><span class="n">query</span><span class="o">[(</span><span class="kt">Country</span>, <span class="kt">Option</span><span class="o">[</span><span class="kt">City</span><span class="o">])]</span>
</code></pre>
</div>

<p>Some examples, filtered for size.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="n">join</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_1</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startsWith</span><span class="o">(</span><span class="s">"United"</span><span class="o">)).</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span>
  <span class="o">(</span><span class="nc">Country</span><span class="o">(</span><span class="nc">United</span> <span class="nc">Arab</span> <span class="nc">Emirates</span><span class="o">,</span><span class="nc">ARE</span><span class="o">),</span><span class="nc">Some</span><span class="o">(</span><span class="nc">City</span><span class="o">(</span><span class="nc">Abu</span> <span class="nc">Dhabi</span><span class="o">,</span><span class="nc">Abu</span> <span class="nc">Dhabi</span><span class="o">)))</span>
  <span class="o">(</span><span class="nc">Country</span><span class="o">(</span><span class="nc">United</span> <span class="nc">Kingdom</span><span class="o">,</span><span class="nc">GBR</span><span class="o">),</span><span class="nc">Some</span><span class="o">(</span><span class="nc">City</span><span class="o">(</span><span class="nc">London</span><span class="o">,</span><span class="nc">England</span><span class="o">)))</span>
  <span class="o">(</span><span class="nc">Country</span><span class="o">(</span><span class="nc">United</span> <span class="nc">States</span><span class="o">,</span><span class="nc">USA</span><span class="o">),</span><span class="nc">Some</span><span class="o">(</span><span class="nc">City</span><span class="o">(</span><span class="nc">Washington</span><span class="o">,</span><span class="nc">District</span> <span class="n">of</span> <span class="nc">Columbia</span><span class="o">)))</span>
  <span class="o">(</span><span class="nc">Country</span><span class="o">(</span><span class="nc">United</span> <span class="nc">States</span> <span class="nc">Minor</span> <span class="nc">Outlying</span> <span class="nc">Islands</span><span class="o">,</span><span class="nc">UMI</span><span class="o">),</span><span class="nc">None</span><span class="o">)</span>
</code></pre>
</div>

<h3 id="how-do-i-resolve-error-could-not-find-or-construct-param">How do I resolve <code class="highlighter-rouge">error: Could not find or construct Param[...]</code>?</h3>

<p>When we use the <code class="highlighter-rouge">sql</code> interpolator we require a <code class="highlighter-rouge">Param</code> instance for an <code class="highlighter-rouge">HList</code> composed of the types of the interpolated query parameters. For instance, in the following code (which has parameters of type <code class="highlighter-rouge">String</code> and <code class="highlighter-rouge">UUID</code>, in that order) we need a <code class="highlighter-rouge">Param[String :: UUID :: HNil]</code> and none is available.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>scala&gt; def query(s: String, u: UUID) = sql"… $s … $u …".query[Int]
&lt;console&gt;:38: error: Could not find or construct Param[String :: java.util.UUID :: shapeless.HNil].
Ensure that this type is an atomic type with an Meta instance in scope, or is an HList whose members
have Meta instances in scope. You can usually diagnose this problem by trying to summon the Meta
instance for each element in the REPL. See the FAQ in the Book of Doobie for more hints.
       def query(s: String, u: UUID) = sql"… $s … $u …".query[Int]
                                       ^
</code></pre>
</div>

<p>Ok, so the message suggests that we need an <code class="highlighter-rouge">Meta[A]</code> for each <code class="highlighter-rouge">A</code> or <code class="highlighter-rouge">Option[A]</code> in the <code class="highlighter-rouge">HList</code>, so let’s see which one is missing by trying to summon them in the REPL.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>scala&gt; Meta[String]
res11: doobie.util.meta.Meta[String] = doobie.util.meta$Meta$$anon$3@40ea9796

scala&gt; Meta[UUID]
&lt;console&gt;:38: error: Could not find an instance of Meta[java.util.UUID]; you can construct one based on a primitive instance via `xmap`.
       Meta[UUID]
           ^
</code></pre>
</div>

<p>So what this means is that we have not defined a mapping for the <code class="highlighter-rouge">UUID</code> type to an underlying JDBC type, and <strong>doobie</strong> doesn’t know how to set an argument of that type on the underlying <code class="highlighter-rouge">PreparedStatement</code>. So we have a few choices. We can <code class="highlighter-rouge">xmap</code> from an existing <code class="highlighter-rouge">Meta</code> instance, as described in <a href="10-Custom-Mappings.html">Chapter 10</a>; or we can import a provided mapping from a vendor-specific <code class="highlighter-rouge">contrib</code> package. Since we’re using PostgreSQL here, let’s do that.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">doobie.postgres.implicits._</span>
<span class="k">import</span> <span class="nn">doobie.postgres.implicits._</span>
</code></pre>
</div>

<p>Having done this, the <code class="highlighter-rouge">Meta</code> and <code class="highlighter-rouge">Param</code> instances are now present and our code compiles.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Meta</span><span class="o">[</span><span class="kt">UUID</span><span class="o">]</span>
<span class="n">res13</span><span class="k">:</span> <span class="kt">doobie.util.meta.Meta</span><span class="o">[</span><span class="kt">java.util.UUID</span><span class="o">]</span> <span class="k">=</span> <span class="n">doobie</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">meta$Meta$$anon$4</span><span class="k">@</span><span class="mi">6</span><span class="n">becf4c5</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Param</span><span class="o">[</span><span class="kt">String</span> <span class="kt">::</span> <span class="kt">UUID</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]</span>
<span class="n">res14</span><span class="k">:</span> <span class="kt">doobie.util.param.Param</span><span class="o">[</span><span class="kt">String</span> <span class="kt">::</span> <span class="kt">java.util.UUID</span> <span class="kt">::</span> <span class="kt">shapeless.HNil</span><span class="o">]</span> <span class="k">=</span> <span class="n">doobie</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">param$Param</span><span class="k">@</span><span class="mi">35173</span><span class="n">ca6</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="k">def</span> <span class="n">query</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">u</span><span class="k">:</span> <span class="kt">UUID</span><span class="o">)</span> <span class="k">=</span> <span class="n">sql</span><span class="s">"select ... where foo = $s and url = $u"</span><span class="o">.</span><span class="n">query</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
<span class="n">query</span><span class="k">:</span> <span class="o">(</span><span class="kt">s:</span> <span class="kt">String</span><span class="o">,</span> <span class="kt">u:</span> <span class="kt">java.util.UUID</span><span class="o">)</span><span class="n">doobie</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="nc">Query0</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
</code></pre>
</div>

<h3 id="how-do-i-resolve-error-could-not-find-or-construct-composite">How do I resolve <code class="highlighter-rouge">error: Could not find or construct Composite[...]</code>?</h3>

<p>When we use the <code class="highlighter-rouge">sql</code> interpolator and use the <code class="highlighter-rouge">.query[A]</code> method we require a <code class="highlighter-rouge">Composite</code> instance for the output type <code class="highlighter-rouge">A</code>, which we can define directly (as described in <a href="10-Custom-Mappings.html">Chapter 10</a>) or derive automatically if <code class="highlighter-rouge">A</code> has a <code class="highlighter-rouge">Meta</code> instance, or is an option thereof, or a product type whose elements have <code class="highlighter-rouge">Composite</code> instances.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Point</span><span class="o">(</span><span class="n">lat</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span> <span class="n">lon</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">City</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">loc</span><span class="k">:</span> <span class="kt">Point</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">State</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">capitol</span><span class="k">:</span> <span class="kt">City</span><span class="o">)</span>
</code></pre>
</div>

<p>In this case if we were to say <code class="highlighter-rouge">.query[State]</code> the derivation would be automatic, because all elements of the “flattened” structure have <code class="highlighter-rouge">Meta</code> instances for free.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="nc">State</span><span class="o">(</span><span class="nc">String</span><span class="o">,</span> <span class="nc">City</span><span class="o">(</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Point</span><span class="o">(</span><span class="nc">Double</span><span class="o">,</span> <span class="nc">Double</span><span class="o">)))</span> <span class="c1">// our structure
</span>     <span class="o">(</span><span class="nc">String</span><span class="o">,</span>     <span class="o">(</span><span class="nc">String</span><span class="o">,</span>      <span class="o">(</span><span class="nc">Double</span><span class="o">,</span> <span class="nc">Double</span><span class="o">)))</span> <span class="c1">// is isomorphic to this
</span>      <span class="nc">String</span><span class="o">,</span>      <span class="nc">String</span><span class="o">,</span>       <span class="nc">Double</span><span class="o">,</span> <span class="nc">Double</span>    <span class="c1">// so we expect a column vector of this shape
</span></code></pre>
</div>

<p>But what if we wanted to use AWT’s <code class="highlighter-rouge">Point2D.Double</code> instead of our own <code class="highlighter-rouge">Point</code> class?</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">City</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">loc</span><span class="k">:</span> <span class="kt">Point2D.Double</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">State</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">capitol</span><span class="k">:</span> <span class="kt">City</span><span class="o">)</span>
</code></pre>
</div>

<p>The derivation now fails.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>scala&gt; sql"…".query[State]
&lt;console&gt;:43: error: Could not find or construct Composite[State].

  If State is a simple type (or option thereof) that maps to a single column, you're
  probably missing a Meta instance. If State is a product type (typically a case class,
  tuple, or HList) then probably one of its component types is missing a Composite instance. You can
  usually diagnose this by evaluating Composite[Foo] for each element Foo of the product type in
  question. See the FAQ in the Book of Doobie for more hints.

       sql"…".query[State]
                   ^
</code></pre>
</div>

<p>And if we look at the flat structure it’s clear that the culprit has to be <code class="highlighter-rouge">Point2D.Double</code> since we know <code class="highlighter-rouge">String</code> has a defined column mapping.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="nc">State</span><span class="o">(</span><span class="nc">String</span><span class="o">,</span> <span class="nc">City</span><span class="o">(</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Point2D</span><span class="o">.</span><span class="nc">Double</span><span class="o">))</span> <span class="c1">// our structure
</span>     <span class="o">(</span><span class="nc">String</span><span class="o">,</span>     <span class="o">(</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Point2D</span><span class="o">.</span><span class="nc">Double</span><span class="o">))</span> <span class="c1">// is isomorphic to this
</span>      <span class="nc">String</span><span class="o">,</span>      <span class="nc">String</span><span class="o">,</span> <span class="nc">Point2D</span><span class="o">.</span><span class="nc">Double</span>   <span class="c1">// so we expect a column vector of this shape
</span></code></pre>
</div>

<p>And indeed this type has no column vector mapping.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>scala&gt; Composite[Point2D.Double]
&lt;console&gt;:41: error: Could not find or construct Composite[java.awt.geom.Point2D.Double].

  If java.awt.geom.Point2D.Double is a simple type (or option thereof) that maps to a single column, you're
  probably missing a Meta instance. If java.awt.geom.Point2D.Double is a product type (typically a case class,
  tuple, or HList) then probably one of its component types is missing a Composite instance. You can
  usually diagnose this by evaluating Composite[Foo] for each element Foo of the product type in
  question. See the FAQ in the Book of Doobie for more hints.

       Composite[Point2D.Double]
                ^
</code></pre>
</div>

<p>If this were an atomic type it would be a matter of importing or defining a <code class="highlighter-rouge">Meta</code> instance, but here we need to define a <code class="highlighter-rouge">Composite</code> directly because we’re mapping a type with several members. As this type is isomorphic to <code class="highlighter-rouge">(Double, Double)</code> we can simply base our mapping off of the existing <code class="highlighter-rouge">Composite</code>.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">implicit</span> <span class="k">val</span> <span class="nc">Point2DComposite</span><span class="k">:</span> <span class="kt">Composite</span><span class="o">[</span><span class="kt">Point2D.Double</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Composite</span><span class="o">[(</span><span class="kt">Double</span>, <span class="kt">Double</span><span class="o">)].</span><span class="n">imap</span><span class="o">(</span>
    <span class="o">(</span><span class="n">t</span><span class="k">:</span> <span class="o">(</span><span class="kt">Double</span><span class="o">,</span> <span class="kt">Double</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">Point2D</span><span class="o">.</span><span class="nc">Double</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="n">_1</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="n">_2</span><span class="o">))(</span>
    <span class="o">(</span><span class="n">p</span><span class="k">:</span> <span class="kt">Point2D.Double</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="o">)</span>
  <span class="o">)</span>
</code></pre>
</div>

<p>Our derivation now works and the code compiles.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="n">sql</span><span class="s">"…"</span><span class="o">.</span><span class="n">query</span><span class="o">[</span><span class="kt">State</span><span class="o">]</span>
<span class="n">res17</span><span class="k">:</span> <span class="kt">doobie.util.query.Query0</span><span class="o">[</span><span class="kt">State</span><span class="o">]</span> <span class="k">=</span> <span class="n">doobie</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">query$Query$$anon$7</span><span class="k">@</span><span class="mf">475f1d</span><span class="mi">1</span>
</code></pre>
</div>

<h3 id="how-do-i-time-query-execution">How do I time query execution?</h3>

<h3 id="how-do-i-log-the-sql-produced-for-my-query-after-interpolation">How do I log the SQL produced for my query after interpolation?</h3>

<p>As of <strong>doobie</strong> 0.4 there is a reasonable solution to the logging/instrumentation question. See <a href="10-Logging.html">Chapter 10</a> for more details.</p>

<h3 id="why-is-there-no-metasqlxml">Why is there no <code class="highlighter-rouge">Meta[SQLXML]</code>?</h3>

<p>There are a lot of ways to handle <code class="highlighter-rouge">SQLXML</code> so there is no pre-defined strategy, but here is one that maps <code class="highlighter-rouge">scala.xml.Elem</code> to <code class="highlighter-rouge">SQLXML</code> via streaming.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">doobie.enum.JdbcType.Other</span>
<span class="k">import</span> <span class="nn">java.sql.SQLXML</span>
<span class="k">import</span> <span class="nn">scala.xml.</span><span class="o">{</span> <span class="nc">XML</span><span class="o">,</span> <span class="nc">Elem</span> <span class="o">}</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nc">XmlMeta</span><span class="k">:</span> <span class="kt">Meta</span><span class="o">[</span><span class="kt">Elem</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Meta</span><span class="o">.</span><span class="n">advanced</span><span class="o">[</span><span class="kt">Elem</span><span class="o">](</span>
    <span class="nc">NonEmptyList</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="nc">Other</span><span class="o">),</span>
    <span class="nc">NonEmptyList</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="s">"xml"</span><span class="o">),</span>
    <span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">XML</span><span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="n">getObject</span><span class="o">(</span><span class="n">n</span><span class="o">).</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">SQLXML</span><span class="o">].</span><span class="n">getBinaryStream</span><span class="o">),</span>
    <span class="o">(</span><span class="n">ps</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span>  <span class="n">e</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">sqlXml</span> <span class="k">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">getConnection</span><span class="o">.</span><span class="n">createSQLXML</span>
      <span class="k">val</span> <span class="n">osw</span> <span class="k">=</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="nc">OutputStreamWriter</span><span class="o">(</span><span class="n">sqlXml</span><span class="o">.</span><span class="n">setBinaryStream</span><span class="o">)</span>
      <span class="nc">XML</span><span class="o">.</span><span class="n">write</span><span class="o">(</span><span class="n">osw</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="s">"UTF-8"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span>
      <span class="n">osw</span><span class="o">.</span><span class="n">close</span>
      <span class="n">ps</span><span class="o">.</span><span class="n">setObject</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">sqlXml</span><span class="o">)</span>
    <span class="o">},</span>
    <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span>  <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">"update not supported, sorry"</span><span class="o">)</span>
  <span class="o">)</span>
</code></pre>
</div>

<h2 id="how-do-i-set-the-chunk-size-for-streaming-results">How do I set the chunk size for streaming results?</h2>

<p>By default streams constructed with the <code class="highlighter-rouge">sql</code> interpolator are fetched <code class="highlighter-rouge">Query.DefaultChunkSize</code> rows at a time (currently 512). If you wish to change this chunk size you can use <code class="highlighter-rouge">processWithChunkSize</code> for queries, and <code class="highlighter-rouge">withGeneratedKeysWithChunkSize</code> for updates that return results.</p>

<h2 id="my-postgres-domains-are-all-type-checking-as-distinct-how-can-i-get-my-yolo-tests-to-pass">My Postgres domains are all type checking as DISTINCT! How can I get my Yolo tests to pass?</h2>

<p>Domains with check constraints will type check as DISTINCT. For Doobie later than 0.4.4, in order to get the type checks to pass, you can define a <code class="highlighter-rouge">Meta</code> of with target type Distinct and <code class="highlighter-rouge">xmap</code> that instances. For example,</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.data.NonEmptyList</span>
<span class="k">import</span> <span class="nn">doobie._</span>
<span class="k">import</span> <span class="nn">doobie.enum.JdbcType.</span><span class="o">{</span><span class="nc">Distinct</span> <span class="k">=&gt;</span> <span class="nc">JdbcDistinct</span><span class="o">,</span> <span class="k">_</span><span class="o">}</span>

<span class="k">object</span> <span class="nc">distinct</span> <span class="o">{</span>
<span class="k">def</span> <span class="n">string</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Meta</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Meta</span><span class="o">.</span><span class="n">advanced</span><span class="o">(</span>
    <span class="nc">NonEmptyList</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="nc">JdbcDistinct</span><span class="o">,</span> <span class="nc">VarChar</span><span class="o">),</span>
    <span class="nc">NonEmptyList</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">name</span><span class="o">),</span>
    <span class="k">_</span> <span class="n">getString</span> <span class="k">_</span><span class="o">,</span>
    <span class="k">_</span><span class="o">.</span><span class="n">setString</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">),</span>
    <span class="k">_</span><span class="o">.</span><span class="n">updateString</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span>
  <span class="o">)</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">NonEmptyString</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="c1">// If the domain for NonEmptyStrings is nes
</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">nesMeta</span><span class="k">:</span> <span class="kt">Meta</span><span class="o">[</span><span class="kt">NonEmptyString</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">string</span><span class="o">(</span><span class="s">"nes"</span><span class="o">).</span><span class="n">xmap</span><span class="o">(</span><span class="nc">NonEmptyString</span><span class="o">.</span><span class="n">apply</span><span class="o">,</span> <span class="k">_</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
  <span class="o">}</span>
</code></pre>
</div>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/doobie/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/doobie/js/main.js"></script></body></html>